<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULM Manager - Gestion Aéronautique</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuration de la police Inter */
        html { font-family: 'Inter', sans-serif; }
        /* Style général du corps */
        body { background-color: #f7f9fc; }
        /* Masquer le menu sur les petits écrans par défaut */
        #nav-menu {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 767px) {
            #nav-menu.hidden-mobile {
                transform: translateX(-100%);
            }
            #nav-menu.show-mobile {
                transform: translateX(0);
                z-index: 50;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e3a8a', /* Dark Blue */
                        'secondary-yellow': '#facc15', /* Amber */
                        'bg-light': '#f7f9fc',
                        'card-bg': '#ffffff',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Chargement des modules Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state and utility functions
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.currentView = 'dashboard';

        // Data holders
        window.flights = [];
        window.reservations = [];
        window.accounts = { totalHours: 0, fuelBalance: 0, cashBalance: 0 };
        window.ulmList = []; // Liste des ULM disponibles

        // Helper: Formatage de l'argent
        window.formatCurrency = (amount) => {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        };

        // Helper: Formatage des heures
        window.formatHours = (minutes) => {
            if (typeof minutes !== 'number' || isNaN(minutes)) return '0h00';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h}h${m.toString().padStart(2, '0')}`;
        };

        // Helper: Conversion 'HhMM' string vers minutes
        window.hhmmsToMinutes = (hhmms) => {
            if (!hhmms) return 0;
            const match = hhmms.match(/^(\d+)h(\d{2})$/);
            if (match) {
                const hours = parseInt(match[1], 10);
                const minutes = parseInt(match[2], 10);
                return (hours * 60) + minutes;
            }
            return 0;
        };

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        const initializeFirebase = async () => {
            try {
                // IMPORTANT: Use the global variables provided by the canvas environment
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing. Data persistence will not work.");
                    // Fallback to in-memory state if config is missing (for local testing)
                    window.renderApp();
                    return;
                }

                // Initialize App and Services
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Set Firestore log level for debugging
                setLogLevel('debug');

                // Authentication
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                    } else {
                        // Sign in with custom token if available, otherwise anonymously
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                            window.userId = window.auth.currentUser.uid;
                        } else {
                            await signInAnonymously(window.auth);
                            window.userId = window.auth.currentUser.uid;
                        }
                    }

                    // Once authenticated, start listening for data
                    if (window.userId) {
                        console.log("Authenticated with userId:", window.userId);
                        document.getElementById('user-id-display').textContent = 'ID Utilisateur: ' + window.userId;
                        startDataListeners();
                        window.renderApp(); // Initial render after auth
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                window.renderMessage("Erreur d'initialisation", "Impossible de se connecter à la base de données. Veuillez vérifier la console pour plus de détails.", "bg-red-500");
            }
        };

        // --- DATA LISTENERS (Firestore) ---

        const startDataListeners = () => {
            if (!window.db || !window.userId) return;

            // 1. Liste des ULM (Public/Shared data)
            const ulmColRef = collection(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "public", "data", "ulmList");
            onSnapshot(ulmColRef, (snapshot) => {
                window.ulmList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // If the list is empty, initialize with default values (e.g., for first run)
                if (window.ulmList.length === 0) {
                    initializeUlmList();
                }
                window.renderApp();
            }, (error) => {
                console.error("Error listening to ULM list:", error);
            });

            // 2. Réservations (Public/Shared data)
            const reservationsColRef = collection(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "public", "data", "reservations");
            onSnapshot(reservationsColRef, (snapshot) => {
                window.reservations = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date ? doc.data().date.toDate() : null // Convert Firestore Timestamp to Date
                })).sort((a, b) => (a.date < b.date ? -1 : 1));
                window.renderApp();
            }, (error) => {
                console.error("Error listening to reservations:", error);
            });

            // 3. Vols (Private user data)
            const flightsColRef = collection(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "users", window.userId, "flights");
            onSnapshot(flightsColRef, (snapshot) => {
                window.flights = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().date ? doc.data().date.toDate() : null // Convert Firestore Timestamp to Date
                })).sort((a, b) => (a.date < b.date ? 1 : -1)); // Sort by date descending (most recent first)
                updateAccounts();
                window.renderApp();
            }, (error) => {
                console.error("Error listening to flights:", error);
            });

            // 4. Comptes (Private user data, stored as a single document)
            const accountDocRef = doc(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "users", window.userId, "accounts", "userBalance");
            onSnapshot(accountDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    window.accounts = docSnapshot.data();
                } else {
                    // Initialize if not exists
                    window.accounts = { totalHours: 0, fuelBalance: 0, cashBalance: 0 };
                    setDoc(accountDocRef, window.accounts);
                }
                window.renderApp();
            }, (error) => {
                console.error("Error listening to accounts:", error);
            });
        };

        // Initialize ULM list if empty (for new users/environments)
        const initializeUlmList = async () => {
            const ulmColRef = collection(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "public", "data", "ulmList");
            const defaultUlms = [
                { registration: 'F-JOLI', model: 'Sky Ranger', hourRate: 95, fuelConsumption: 12, maxFuel: 70 },
                { registration: 'F-COOL', model: 'Savage Cub', hourRate: 110, fuelConsumption: 15, maxFuel: 80 },
                { registration: 'F-ZEN', model: 'Nynja', hourRate: 100, fuelConsumption: 10, maxFuel: 60 },
            ];
            for (const ulm of defaultUlms) {
                await addDoc(ulmColRef, ulm);
            }
        };

        // --- ACCOUNTING LOGIC ---
        const updateAccounts = () => {
            let totalFlightTimeMinutes = 0;
            let fuelConsumedLiters = 0;
            let cashEarned = 0;

            window.flights.forEach(flight => {
                const durationMinutes = window.hhmmsToMinutes(flight.duration);
                totalFlightTimeMinutes += durationMinutes;

                const ulm = window.ulmList.find(u => u.registration === flight.ulmRegistration);
                if (ulm) {
                    // Fuel consumption calculation (simplified)
                    const consumption = (ulm.fuelConsumption / 60) * durationMinutes;
                    fuelConsumedLiters += consumption;
                    
                    // Cash earned/spent calculation (assuming hourRate is per flight hour in EUR)
                    const hourRate = ulm.hourRate || 100; // Default rate if missing
                    const cost = (hourRate / 60) * durationMinutes;
                    cashEarned += cost; // Placeholder: Simplistically adding cost to cash for demonstration
                }
            });

            // Simplified update: Total hours flown, fuel balance (simulated), and cash balance (simulated)
            const newAccounts = {
                totalHours: totalFlightTimeMinutes,
                fuelBalance: window.accounts.fuelBalance - fuelConsumedLiters, // Deduct consumed fuel
                cashBalance: window.accounts.cashBalance + cashEarned // Add simulated income
            };

            const accountDocRef = doc(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "users", window.userId, "accounts", "userBalance");
            setDoc(accountDocRef, newAccounts, { merge: true }).catch(e => console.error("Error updating accounts:", e));
        };


        // --- UI RENDERING & ROUTING ---

        window.renderMessage = (title, message, bgColor = "bg-primary-blue") => {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div class="p-6 md:p-10 rounded-xl shadow-lg ${bgColor} text-white max-w-lg mx-auto mt-10">
                    <h2 class="text-2xl font-bold mb-3">${title}</h2>
                    <p>${message}</p>
                </div>
            `;
        };

        window.renderApp = () => {
            const container = document.getElementById('main-content');
            if (!window.userId) {
                window.renderMessage("Chargement...", "Authentification en cours...", "bg-gray-500");
                return;
            }

            // Simple client-side router
            switch (window.currentView) {
                case 'dashboard':
                    container.innerHTML = renderDashboard();
                    break;
                case 'reservation':
                    container.innerHTML = renderReservation();
                    break;
                case 'log-flight':
                    container.innerHTML = renderLogFlight();
                    break;
                case 'accounting':
                    container.innerHTML = renderAccounting();
                    break;
                default:
                    container.innerHTML = renderDashboard();
            }
            // Re-attach event listeners after DOM update
            attachEventListeners();
        };

        window.navigateTo = (view) => {
            window.currentView = view;
            window.renderApp();
            // Close mobile menu after navigation
            if (window.innerWidth < 768) {
                document.getElementById('nav-menu').classList.remove('show-mobile');
                document.getElementById('nav-menu').classList.add('hidden-mobile');
                document.getElementById('menu-button').classList.remove('hidden');
                document.getElementById('close-button').classList.add('hidden');
            }
        };

        // --- VIEW TEMPLATES ---

        const renderDashboard = () => {
            const totalHours = window.formatHours(window.accounts.totalHours);
            const nextReservation = window.reservations.find(r => r.date && r.date >= new Date());
            const latestFlight = window.flights[0]; // Already sorted descending

            return `
                <div class="space-y-8 p-4 md:p-8">
                    <h1 class="text-3xl font-extrabold text-primary-blue border-b-2 border-secondary-yellow pb-2">Tableau de Bord</h1>

                    <!-- Statistiques Clés -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Total Heures de Vol -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-md transition duration-300 hover:shadow-lg border-t-4 border-primary-blue">
                            <p class="text-sm font-medium text-gray-500">Total Heures de Vol (Pilote)</p>
                            <p class="text-4xl font-bold text-primary-blue mt-1">${totalHours}</p>
                        </div>
                        <!-- Solde Caisse -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-md transition duration-300 hover:shadow-lg border-t-4 border-secondary-yellow">
                            <p class="text-sm font-medium text-gray-500">Solde Caisse (Simulé)</p>
                            <p class="text-4xl font-bold text-green-600 mt-1">${window.formatCurrency(window.accounts.cashBalance)}</p>
                        </div>
                        <!-- ULM Disponibles -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-md transition duration-300 hover:shadow-lg border-t-4 border-gray-400">
                            <p class="text-sm font-medium text-gray-500">ULM Enregistrés</p>
                            <p class="text-4xl font-bold text-gray-800 mt-1">${window.ulmList.length}</p>
                        </div>
                    </div>

                    <!-- Prochaine Réservation -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                            Prochaine Réservation
                            <button onclick="window.navigateTo('reservation')" class="text-sm font-medium text-primary-blue hover:text-primary-blue/80 transition">Voir toutes</button>
                        </h2>
                        ${nextReservation ? `
                            <p class="text-2xl font-bold text-green-600">${nextReservation.ulmRegistration}</p>
                            <p class="text-gray-600 mt-1">Le ${nextReservation.date.toLocaleDateString('fr-FR')} à ${nextReservation.date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p>
                            <p class="text-sm text-gray-500 mt-2">Destination : ${nextReservation.destination}</p>
                        ` : `
                            <p class="text-gray-500 italic">Aucune réservation à venir.</p>
                            <button onclick="window.navigateTo('reservation')" class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-secondary-yellow hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-yellow">
                                Réserver un ULM
                            </button>
                        `}
                    </div>

                    <!-- Dernier Vol -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4 flex justify-between items-center">
                            Dernier Vol Enregistré
                            <button onclick="window.navigateTo('log-flight')" class="text-sm font-medium text-primary-blue hover:text-primary-blue/80 transition">Voir Log de Vol</button>
                        </h2>
                        ${latestFlight ? `
                            <div class="border-l-4 border-primary-blue pl-4">
                                <p class="text-lg font-bold">${latestFlight.ulmRegistration} - ${latestFlight.date.toLocaleDateString('fr-FR')}</p>
                                <p class="text-gray-600">Durée : <span class="font-semibold">${latestFlight.duration}</span></p>
                                <p class="text-sm text-gray-500">De ${latestFlight.departure} à ${latestFlight.arrival}</p>
                            </div>
                        ` : `
                            <p class="text-gray-500 italic">Aucun vol enregistré pour le moment.</p>
                        `}
                    </div>
                </div>
            `;
        };

        const renderReservation = () => {
            const today = new Date().toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM format

            const reservationListHTML = window.reservations.length > 0
                ? window.reservations.map(res => {
                    const statusClass = res.date < new Date() ? 'text-red-500' : 'text-green-600';
                    return `
                        <div class="p-4 bg-white rounded-lg shadow flex justify-between items-center border-l-4 border-primary-blue">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${res.ulmRegistration} - ${res.destination}</p>
                                <p class="text-sm text-gray-600">${res.date.toLocaleDateString('fr-FR')} à ${res.date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</p>
                                <p class="text-xs mt-1 ${statusClass}">${res.date < new Date() ? 'Passée' : 'À venir'}</p>
                            </div>
                            <button data-reservation-id="${res.id}" class="delete-reservation-btn text-red-500 hover:text-red-700 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;
                }).join('')
                : '<p class="text-gray-500 italic p-4 text-center">Aucune réservation enregistrée.</p>';

            const ulmOptions = window.ulmList.map(ulm =>
                `<option value="${ulm.registration}">${ulm.registration} (${ulm.model}) - ${ulm.hourRate}€/h</option>`
            ).join('');

            return `
                <div class="space-y-8 p-4 md:p-8">
                    <h1 class="text-3xl font-extrabold text-primary-blue border-b-2 border-secondary-yellow pb-2">Gestion des Réservations</h1>

                    <!-- Formulaire de Nouvelle Réservation -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Nouvelle Réservation</h2>
                        <form id="reservation-form" class="space-y-4">
                            <div>
                                <label for="res-ulm" class="block text-sm font-medium text-gray-700">ULM</label>
                                <select id="res-ulm" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md shadow-sm">
                                    <option value="">Sélectionner un ULM</option>
                                    ${ulmOptions}
                                </select>
                            </div>
                            <div>
                                <label for="res-datetime" class="block text-sm font-medium text-gray-700">Date & Heure</label>
                                <input type="datetime-local" id="res-datetime" required min="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="res-destination" class="block text-sm font-medium text-gray-700">Destination/Note</label>
                                <input type="text" id="res-destination" placeholder="Ex: Vol local, Navette LFPN" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-blue hover:bg-primary-blue/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150">
                                Enregistrer la Réservation
                            </button>
                        </form>
                    </div>

                    <!-- Liste des Réservations -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Réservations Actuelles et Futures</h2>
                        <div class="space-y-3">
                            ${reservationListHTML}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderLogFlight = () => {
            const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD format

            const flightListHTML = window.flights.length > 0
                ? window.flights.map(flight => {
                    return `
                        <div class="p-4 bg-white rounded-lg shadow border-l-4 border-secondary-yellow">
                            <p class="text-lg font-semibold text-gray-800">${flight.ulmRegistration} (${flight.date.toLocaleDateString('fr-FR')})</p>
                            <p class="text-sm text-gray-600">Durée: <span class="font-bold text-primary-blue">${flight.duration}</span></p>
                            <p class="text-xs text-gray-500">Départ: ${flight.departure}, Arrivée: ${flight.arrival}</p>
                            <p class="text-xs text-gray-500">Notes: ${flight.notes || 'N/A'}</p>
                        </div>
                    `;
                }).join('')
                : '<p class="text-gray-500 italic p-4 text-center">Aucun vol enregistré.</p>';

            const ulmOptions = window.ulmList.map(ulm =>
                `<option value="${ulm.registration}">${ulm.registration} (${ulm.model})</option>`
            ).join('');

            return `
                <div class="space-y-8 p-4 md:p-8">
                    <h1 class="text-3xl font-extrabold text-primary-blue border-b-2 border-secondary-yellow pb-2">Log de Vol</h1>

                    <!-- Formulaire d'Enregistrement de Vol -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Enregistrer un Nouveau Vol</h2>
                        <form id="flight-log-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- ULM -->
                            <div>
                                <label for="flight-ulm" class="block text-sm font-medium text-gray-700">ULM</label>
                                <select id="flight-ulm" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-blue focus:border-primary-blue sm:text-sm rounded-md shadow-sm">
                                    <option value="">Sélectionner un ULM</option>
                                    ${ulmOptions}
                                </select>
                            </div>
                            <!-- Date -->
                            <div>
                                <label for="flight-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="flight-date" required max="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2">
                            </div>
                            <!-- Durée -->
                            <div>
                                <label for="flight-duration" class="block text-sm font-medium text-gray-700">Durée (HhMM)</label>
                                <input type="text" id="flight-duration" pattern="\\d{1,2}h\\d{2}" placeholder="Ex: 1h30" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2">
                                <p class="text-xs text-gray-500 mt-1">Format requis: 1h30, 0h45, 2h00</p>
                            </div>
                            <!-- Départ -->
                            <div>
                                <label for="flight-departure" class="block text-sm font-medium text-gray-700">Aérodrome de Départ</label>
                                <input type="text" id="flight-departure" placeholder="Ex: LFPN" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2">
                            </div>
                            <!-- Arrivée -->
                            <div>
                                <label for="flight-arrival" class="block text-sm font-medium text-gray-700">Aérodrome d'Arrivée</label>
                                <input type="text" id="flight-arrival" placeholder="Ex: LFPB" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2">
                            </div>
                            <!-- Notes -->
                            <div class="md:col-span-2">
                                <label for="flight-notes" class="block text-sm font-medium text-gray-700">Notes de Vol</label>
                                <textarea id="flight-notes" rows="2" placeholder="Ex: Test moteur, atterrissages courts" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-blue focus:ring-primary-blue sm:text-sm p-2"></textarea>
                            </div>

                            <div class="md:col-span-2">
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-blue hover:bg-primary-blue/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150">
                                    Enregistrer le Vol
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Liste des Vols -->
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Historique des Vols</h2>
                        <div class="space-y-3">
                            ${flightListHTML}
                        </div>
                    </div>
                </div>
            `;
        };

        const renderAccounting = () => {
            const cashClass = window.accounts.cashBalance >= 0 ? 'text-green-600' : 'text-red-600';
            const fuelClass = window.accounts.fuelBalance >= 0 ? 'text-green-600' : 'text-red-600';
            const totalHours = window.formatHours(window.accounts.totalHours);

            // Placeholder for a list of transactions (to be implemented)
            const transactionListHTML = '<p class="text-gray-500 italic">L’historique des transactions n’est pas encore disponible, mais le solde est mis à jour après chaque vol.</p>';

            return `
                <div class="space-y-8 p-4 md:p-8">
                    <h1 class="text-3xl font-extrabold text-primary-blue border-b-2 border-secondary-yellow pb-2">Comptabilité & Bilans</h1>

                    <!-- Solde Clés -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Total Heures de Vol -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-md border-t-4 border-gray-400">
                            <p class="text-sm font-medium text-gray-500">Total Heures Volées</p>
                            <p class="text-4xl font-bold text-gray-800 mt-1">${totalHours}</p>
                        </div>
                        <!-- Solde Caisse -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-md border-t-4 border-green-600">
                            <p class="text-sm font-medium text-gray-500">Solde Caisse (Simulé)</p>
                            <p class="text-4xl font-bold ${cashClass} mt-1">${window.formatCurrency(window.accounts.cashBalance)}</p>
                        </div>
                        <!-- Solde Carburant -->
                        <div class="bg-card-bg p-6 rounded-xl shadow-md border-t-4 border-red-600">
                            <p class="text-sm font-medium text-gray-500">Solde Carburant (Simulé - Litres)</p>
                            <p class="text-4xl font-bold ${fuelClass} mt-1">${window.accounts.fuelBalance.toFixed(2)} L</p>
                        </div>
                    </div>

                    <!-- Gestion des ULM (Tarifs) -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Tarifs des ULM</h2>
                        <div class="space-y-3">
                            ${window.ulmList.map(ulm => `
                                <div class="flex justify-between items-center p-3 border-b">
                                    <p class="font-semibold">${ulm.registration} (${ulm.model})</p>
                                    <p class="text-primary-blue font-bold">${window.formatCurrency(ulm.hourRate)} / heure</p>
                                    <p class="text-sm text-gray-500">${ulm.fuelConsumption} L/h</p>
                                </div>
                            `).join('')}
                        </div>
                        <p class="text-sm text-gray-500 mt-4 italic">Ces tarifs sont utilisés pour le calcul simulé du solde de caisse et de carburant.</p>
                    </div>

                    <!-- Historique des transactions (Futur) -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Historique des Transactions</h2>
                        ${transactionListHTML}
                    </div>
                </div>
            `;
        };

        // --- EVENT HANDLERS (Firestore Operations) ---

        const handleReservationSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const ulmRegistration = form['res-ulm'].value;
            const datetimeLocal = form['res-datetime'].value;
            const destination = form['res-destination'].value;

            if (!window.db || !window.userId || !ulmRegistration || !datetimeLocal) return;

            // Convert local datetime string to Date object
            const date = new Date(datetimeLocal);

            const newReservation = {
                ulmRegistration,
                date,
                destination: destination || 'Vol non spécifié',
                reservedBy: window.userId,
                createdAt: serverTimestamp()
            };

            try {
                const reservationsColRef = collection(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "public", "data", "reservations");
                await addDoc(reservationsColRef, newReservation);
                window.renderMessage("Succès !", `Réservation de ${ulmRegistration} pour le ${date.toLocaleString('fr-FR')} enregistrée.`, "bg-green-600");
                setTimeout(() => window.navigateTo('reservation'), 1500);
            } catch (error) {
                console.error("Error adding reservation:", error);
                window.renderMessage("Erreur", "Impossible d'ajouter la réservation. Voir console.", "bg-red-500");
            }
        };

        const handleDeleteReservation = async (e) => {
            const button = e.target.closest('.delete-reservation-btn');
            const reservationId = button?.dataset.reservationId;

            if (!reservationId || !window.db) return;

            // Use a custom modal/message box instead of confirm()
            if (!await showConfirmationModal('Confirmation', 'Êtes-vous sûr de vouloir annuler cette réservation ?')) {
                return;
            }

            try {
                const reservationDocRef = doc(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "public", "data", "reservations", reservationId);
                await deleteDoc(reservationDocRef);
                window.renderMessage("Annulée", "La réservation a été supprimée.", "bg-gray-500");
                setTimeout(() => window.navigateTo('reservation'), 1500);
            } catch (error) {
                console.error("Error deleting reservation:", error);
                window.renderMessage("Erreur", "Impossible de supprimer la réservation. Voir console.", "bg-red-500");
            }
        };

        const handleFlightLogSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const ulmRegistration = form['flight-ulm'].value;
            const dateStr = form['flight-date'].value;
            const duration = form['flight-duration'].value;
            const departure = form['flight-departure'].value;
            const arrival = form['flight-arrival'].value;
            const notes = form['flight-notes'].value;

            if (!window.db || !window.userId || !ulmRegistration || !dateStr || !duration) return;

            // Simple date conversion for Firestore
            const date = new Date(dateStr);

            const newFlight = {
                ulmRegistration,
                date,
                duration,
                departure,
                arrival,
                notes,
                pilotId: window.userId,
                createdAt: serverTimestamp()
            };

            try {
                const flightsColRef = collection(window.db, "artifacts", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id', "users", window.userId, "flights");
                await addDoc(flightsColRef, newFlight);
                window.renderMessage("Vol Enregistré", `${ulmRegistration} - ${duration} ajouté à votre log.`, "bg-green-600");
                setTimeout(() => window.navigateTo('log-flight'), 1500);
            } catch (error) {
                console.error("Error adding flight log:", error);
                window.renderMessage("Erreur", "Impossible d'ajouter le vol. Voir console.", "bg-red-500");
            }
        };

        // --- MODAL / MESSAGE BOX IMPLEMENTATION (Replacing alert/confirm) ---

        // Function to show a custom confirmation modal
        window.showConfirmationModal = (title, message) => {
            return new Promise(resolve => {
                const modalHtml = `
                    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">${title}</h3>
                            <p class="text-sm text-gray-500 mb-6">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button id="modal-cancel" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 transition">
                                    Annuler
                                </button>
                                <button id="modal-confirm" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition">
                                    Confirmer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);

                const modal = document.getElementById('custom-modal');
                document.getElementById('modal-cancel').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                document.getElementById('modal-confirm').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
            });
        };

        // --- GENERAL EVENT LISTENERS & INITIALIZATION ---

        const attachEventListeners = () => {
            // Reservation Form
            const resForm = document.getElementById('reservation-form');
            if (resForm) {
                resForm.onsubmit = handleReservationSubmit;
            }

            // Delete Reservation Buttons
            document.querySelectorAll('.delete-reservation-btn').forEach(button => {
                button.onclick = handleDeleteReservation;
            });

            // Flight Log Form
            const flightForm = document.getElementById('flight-log-form');
            if (flightForm) {
                flightForm.onsubmit = handleFlightLogSubmit;
            }

            // Mobile Menu Toggle
            const menuButton = document.getElementById('menu-button');
            const closeButton = document.getElementById('close-button');
            const navMenu = document.getElementById('nav-menu');

            if (menuButton && closeButton && navMenu) {
                menuButton.onclick = () => {
                    navMenu.classList.remove('hidden-mobile');
                    navMenu.classList.add('show-mobile');
                    menuButton.classList.add('hidden');
                    closeButton.classList.remove('hidden');
                };
                closeButton.onclick = () => {
                    navMenu.classList.remove('show-mobile');
                    navMenu.classList.add('hidden-mobile');
                    menuButton.classList.remove('hidden');
                    closeButton.classList.add('hidden');
                };
            }
        };

        // Start the application after the document is loaded
        window.onload = initializeFirebase;

    </script>


    <!-- --- APPLICATION STRUCTURE (HTML) --- -->

    <!-- Header / Navigation Bar -->
    <header class="bg-primary-blue text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Title -->
                <div class="flex-shrink-0">
                    <span class="text-xl font-bold tracking-wider">ULM Manager</span>
                </div>

                <!-- Desktop Menu -->
                <nav class="hidden md:flex md:space-x-8">
                    <button onclick="window.navigateTo('dashboard')" class="text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Tableau de Bord</button>
                    <button onclick="window.navigateTo('reservation')" class="text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Réservations</button>
                    <button onclick="window.navigateTo('log-flight')" class="text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Log de Vol</button>
                    <button onclick="window.navigateTo('accounting')" class="text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-sm font-medium transition duration-150">Comptabilité</button>
                </nav>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-300 hover:text-white hover:bg-primary-blue/70 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                    <button id="close-button" type="button" class="hidden inline-flex items-center justify-center p-2 rounded-md text-gray-300 hover:text-white hover:bg-primary-blue/70 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                        <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu (Hidden by default) -->
        <div id="nav-menu" class="md:hidden absolute top-0 left-0 h-screen w-3/4 bg-primary-blue shadow-2xl hidden-mobile">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 mt-16">
                <button onclick="window.navigateTo('dashboard')" class="block w-full text-left text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-base font-medium transition duration-150">Tableau de Bord</button>
                <button onclick="window.navigateTo('reservation')" class="block w-full text-left text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-base font-medium transition duration-150">Réservations</button>
                <button onclick="window.navigateTo('log-flight')" class="block w-full text-left text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-base font-medium transition duration-150">Log de Vol</button>
                <button onclick="window.navigateTo('accounting')" class="block w-full text-left text-gray-300 hover:bg-primary-blue/70 px-3 py-2 rounded-md text-base font-medium transition duration-150">Comptabilité</button>
            </div>
            <div class="px-5 py-3 border-t border-primary-blue/50">
                <p id="user-id-display" class="text-xs text-gray-400">ID Utilisateur: Chargement...</p>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto w-full">
        <div id="main-content" class="p-4 sm:p-6 lg:p-8">
            <!-- Content will be injected here by JavaScript (renderApp function) -->
            <div class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-primary-blue"></div>
                <p class="ml-4 text-primary-blue font-semibold">Chargement de l'application...</p>
            </div>
        </div>
    </main>

    <!-- Footer (Optional) -->
    <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-auto">
        <p>&copy; 2024 ULM Manager. Propulsé par Google & Firebase.</p>
    </footer>

</body>
</html>
